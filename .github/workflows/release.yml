name: Build and Release Multi-Platform

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0, v2.1.3, etc.

jobs:
  # ==========================================
  # JOB 1: BUILD MACOS
  # ==========================================
  build-macos:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Download spaCy model
        run: python -m spacy download it_core_news_sm

      - name: Build macOS app
        run: |
          chmod +x build_mac.sh
          ./build_mac.sh

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Create DMG
        run: |
          chmod +x create_dmg.sh
          ./create_dmg.sh

      - name: Get version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Upload macOS DMG
        uses: actions/upload-artifact@v4
        with:
          name: TheNovelist-macOS-${{ steps.get_version.outputs.VERSION }}
          path: TheNovelist.dmg
          retention-days: 90

  # ==========================================
  # JOB 2: BUILD WINDOWS
  # ==========================================
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Download spaCy model
        run: python -m spacy download it_core_news_sm

      - name: Build Windows executable
        run: pyinstaller TheNovelist.spec

      - name: Create ZIP package
        run: |
          Compress-Archive -Path dist\TheNovelist\* -DestinationPath TheNovelist-Windows.zip

      - name: Get version
        id: get_version
        shell: pwsh
        run: echo "VERSION=$($env:GITHUB_REF -replace 'refs/tags/','')" >> $env:GITHUB_OUTPUT

      - name: Upload Windows ZIP
        uses: actions/upload-artifact@v4
        with:
          name: TheNovelist-Windows-${{ steps.get_version.outputs.VERSION }}
          path: TheNovelist-Windows.zip
          retention-days: 90

  # ==========================================
  # JOB 3: BUILD LINUX
  # ==========================================
  build-linux:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libxcb-xinerama0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-randr0 \
            libxcb-render-util0 \
            libxcb-shape0 \
            libxkbcommon-x11-0 \
            libdbus-1-3 \
            libgl1-mesa-glx \
            libegl1-mesa

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Download spaCy model
        run: python -m spacy download it_core_news_sm

      - name: Build Linux executable
        run: |
          chmod +x build_linux.sh
          ./build_linux.sh

      - name: Create tarball
        run: |
          cd dist
          tar -czf TheNovelist-Linux.tar.gz TheNovelist/
          mv TheNovelist-Linux.tar.gz ..

      - name: Get version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Upload Linux tarball
        uses: actions/upload-artifact@v4
        with:
          name: TheNovelist-Linux-${{ steps.get_version.outputs.VERSION }}
          path: TheNovelist-Linux.tar.gz
          retention-days: 90

  # ==========================================
  # JOB 4: CREATE RELEASE
  # ==========================================
  create-release:
    needs: [build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Get version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Display artifacts structure
        run: ls -R artifacts/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/**/*.dmg
            artifacts/**/*.zip
            artifacts/**/*.tar.gz
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## TheNovelist ${{ steps.get_version.outputs.VERSION }}

            ### ğŸ“¥ Download per il tuo Sistema Operativo:

            - **ğŸ macOS**: `TheNovelist.dmg` - Aprire e trascinare nella cartella Applicazioni
            - **ğŸªŸ Windows**: `TheNovelist-Windows.zip` - Estrarre ed eseguire `TheNovelist.exe`
            - **ğŸ§ Linux**: `TheNovelist-Linux.tar.gz` - Estrarre ed eseguire `TheNovelist/TheNovelist`

            ### âœ¨ NovitÃ  in questa versione

            Vedi le note di rilascio generate automaticamente qui sotto.

            ---

            **Requisiti minimi:**
            - macOS 11+, Windows 10+, o Linux (Ubuntu 20.04+)
            - 4GB RAM
            - 1GB spazio su disco
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
